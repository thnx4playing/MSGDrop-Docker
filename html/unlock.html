<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="format-detection" content="telephone=no"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Enter Access Code</title>
<style>
:root { --bg:#0f172a; --surface:#334155; --text:#f1f5f9; --accent:#3b82f6; --danger:#ef4444; --border:rgba(148,163,184,.3); }
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
html,body{height:100%;width:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:24px}
.unlock-container{width:100%;max-width:360px}
.pin-container{display:flex;gap:12px;justify-content:center}
.pin-box{width:64px;height:72px;background:transparent;border:2px solid var(--border);border-radius:12px;font-size:32px;font-weight:700;text-align:center;color:var(--text);transition:all .2s cubic-bezier(.4,0,.2,1);outline:none;caret-color:var(--accent)}
.pin-box:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);transform:scale(1.05)}
.pin-box:not(:placeholder-shown){border-color:var(--accent)}
.pin-box.error{border-color:var(--danger);animation:shake .4s cubic-bezier(.36,.07,.19,.97)}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.error-message{text-align:center;color:var(--danger);font-size:13px;font-weight:600;margin-top:16px;min-height:20px;opacity:0;transform:translateY(-8px);transition:all .3s ease}
.error-message.show{opacity:1;transform:translateY(0)}
.loading-container{display:none}
@media (max-width:480px){.pin-container{gap:10px}.pin-box{width:56px;height:64px;font-size:28px}}
@media (prefers-reduced-motion: reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type="number"]{-moz-appearance:textfield}
</style>
</head>
<body>
  <div class="unlock-container">
    <div class="pin-container">
      <input type="tel" inputmode="numeric" pattern="[0-9]" maxlength="1" class="pin-box" id="pin1" autocomplete="off" aria-label="First digit"/>
      <input type="tel" inputmode="numeric" pattern="[0-9]" maxlength="1" class="pin-box" id="pin2" autocomplete="off" aria-label="Second digit"/>
      <input type="tel" inputmode="numeric" pattern="[0-9]" maxlength="1" class="pin-box" id="pin3" autocomplete="off" aria-label="Third digit"/>
      <input type="tel" inputmode="numeric" pattern="[0-9]" maxlength="1" class="pin-box" id="pin4" autocomplete="off" aria-label="Fourth digit"/>
    </div>
    <div style="text-align:center;margin-top:16px;color:var(--border);font-size:12px;font-weight:500;">V3</div>
    <div id="errorMessage" class="error-message" role="alert"></div>
    <div id="loadingContainer" class="loading-container">
      <div class="loading-spinner"></div>
      <span class="loading-text">Verifying...</span>
    </div>
  </div>
<script>
const API_BASE_URL = '/api';
const urlParams = new URLSearchParams(window.location.search);
const REDIRECT_PATH = decodeURIComponent(urlParams.get('next') || '/msgdrop');
const pinBoxes=[document.getElementById('pin1'),document.getElementById('pin2'),document.getElementById('pin3'),document.getElementById('pin4')];
const errorMessage=document.getElementById('errorMessage');
const loadingContainer=document.getElementById('loadingContainer');
let isSubmitting=false;
function showError(m){errorMessage.textContent=m;errorMessage.classList.add('show');pinBoxes.forEach(b=>b.classList.add('error'));setTimeout(()=>{pinBoxes.forEach(b=>b.classList.remove('error'))},400)}
function hideError(){errorMessage.textContent='';errorMessage.classList.remove('show')}
function clearPins(){pinBoxes.forEach(b=>{b.value=''});pinBoxes[0].focus()}
function getPinValue(){return pinBoxes.map(b=>b.value).join('')}
function isPinComplete(){return pinBoxes.every(b=>b.value.length===1)}
function setupPinInputs(){pinBoxes.forEach((box,i)=>{box.addEventListener('input',e=>{hideError();const v=e.target.value;if(v&&!/^\d$/.test(v)){e.target.value='';return}if(v&&i<3){pinBoxes[i+1].focus()}if(v&&i===3&&isPinComplete()){setTimeout(()=>submitPin(),100)}});box.addEventListener('keydown',e=>{if(e.key==='Backspace'){if(!box.value&&i>0){pinBoxes[i-1].focus();pinBoxes[i-1].value=''}}else if(e.key==='ArrowLeft'&&i>0){pinBoxes[i-1].focus()}else if(e.key==='ArrowRight'&&i<3){pinBoxes[i+1].focus()}else if(e.key==='Enter'&&isPinComplete()){submitPin()}});box.addEventListener('paste',e=>{e.preventDefault();const p=e.clipboardData.getData('text').replace(/\D/g,'').slice(0,4);if(p.length>0){p.split('').forEach((d,idx)=>{if(pinBoxes[idx]){pinBoxes[idx].value=d}});const lastIndex=Math.min(p.length-1,3);pinBoxes[lastIndex].focus();if(p.length===4){setTimeout(()=>submitPin(),100)}}});box.addEventListener('keypress',e=>{if(!/^\d$/.test(e.key)&&e.key!=='Enter'&&e.key!=='Backspace'){e.preventDefault()}})})}
async function submitPin(){if(isSubmitting)return;const pin=getPinValue();if(pin.length!==4){showError('Please enter all 4 digits');return}if(!/^\d{4}$/.test(pin)){showError('PIN must contain only numbers');clearPins();return}isSubmitting=true;hideError();pinBoxes.forEach(b=>b.disabled=true);try{const r=await fetch(`${API_BASE_URL}/unlock`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({code:pin})});if(r.ok||r.status===302||r.redirected){setTimeout(()=>{window.location.href=REDIRECT_PATH},100);return}else if(r.status===401){showError('Invalid code. Please try again.');clearPins();pinBoxes.forEach(b=>b.disabled=false)}else if(r.status===400){showError('Invalid code format. Please try again.');clearPins();pinBoxes.forEach(b=>b.disabled=false)}else{showError(`Server error (${r.status}). Please try again.`);clearPins();pinBoxes.forEach(b=>b.disabled=false)}}catch(e){showError('Network error. Please try again.');clearPins();pinBoxes.forEach(b=>b.disabled=false)}isSubmitting=false}
function init(){setupPinInputs();setTimeout(()=>{pinBoxes[0].focus()},300);document.addEventListener('visibilitychange',()=>{if(!document.hidden&&!isPinComplete()){const f=pinBoxes.find(b=>!b.value);if(f)f.focus()}})}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}
</script>
</body>
</html>

